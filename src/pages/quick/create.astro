---
import BaseLayout from "templates:BaseLayout";
import TimeSelector from "molecules:TimeSelector";
import { weightingOptions } from "composables/weightingOptions";
import { t, changeLanguage } from "i18next";
import WeightingInfo from "molecules:WeightingInfo";
import Alert from "molecules:Alert";
import AlertManager from "organisms:AlertManager";
import DefaultProposalInfo from "molecules:DefaultProposalInfo";
import { Icon } from "astro-icon";


changeLanguage("en");

const weightOptions = weightingOptions();
const topicDescription = "";
const topicQuestion = "";
const weighting = weightOptions[2].value;
const defaultProposals = "";
const proposals = [
    {
        title: t("proposal.zero.title"),
        description: t("proposal.zero.description"),
    },
    {
        title: t("proposal.one.title"),
        description: t("proposal.one.description"),
    },
];
const searchParams = Astro.url.searchParams
const strategy = Number(searchParams.get('strategy')) || 0;

---

<BaseLayout>

  <h1>{ t('quick.title')  }</h1>
  <quick-form data-proposals={JSON.stringify(proposals)} data-strategy={strategy}>
    <p>{ t('quick.topic') }</p>
    <input name="topicQuestion" class="input input-bordered w-full" value={topicQuestion} type="text">
    <br>
    <p>{ t('quick.description') }</p>
    <textarea name="topicDescription" class="textarea textarea-bordered w-full" value={topicDescription} />
    <br><br>
    <span>{ t('quick.weighting') }</span>
    <span class="flex justify-center items-center">
      <select name="weighting" class="select" value={weighting}>
        { weightOptions.map((weight) => 
          <option selected={weighting === weight.value} value={weight.value}>{ weight.label }</option>
        )}
      </select>
      <WeightingInfo />
    </span>
    <br>
    <TimeSelector strategy={strategy}/>
    { strategy === 1 &&  
    <h2>{ t('quick.proposals') }</h2>
    }
    <div class="flex justify-around align-center items-center">
      <div class="flex justify-center items-center">
        <input name="defaultProposals" type="checkbox" checked={defaultProposals} class="checkbox" />

        <span>&nbsp;{ t('quick.addDefaultProposals') }</span>
        <DefaultProposalInfo />
      </div>
    </div>
    { strategy === 1 &&  
    <div class="proposals">
      <div class="proposal bg-base-100 card shadow-xl py-2 px-4 my-4">
          <div class="edit flex justify-between items-center">
              <div class="content flex flex-col w-full">
                  <b>{ t('quick.topic') }</b>
                  <input type="text" class="input input-bordered input-sm my-2"/>
                  <label>{ t('quick.description') }</label>
                  <input type="text" class="input input-bordered input-sm my-2"/>
              </div>
          </div>
      </div>
    </div>
    <button id="add-proposal" class="btn p-2" >
        <Icon width="32" name="add"/> add proposal
    </button>
    }

    <br/>
    <AlertManager>
      <Alert type="error" icon="warning">
        { t('alert.quick.error.topicQuestion') }
      </Alert>
      <Alert type="success" icon="checkmark-outline">
        { t('alert.quick.success.createProcess') } 
      </Alert>
    </AlertManager>
    <br/>
    <div class="text-center">
      <button id="submit" type="submit" class="btn btn-primary">
        { t('create') }
      </button>
    </div>
    
    <br/>

  </quick-form>
</BaseLayout>

<script>
  import { addAlert } from 'composables/addAlert'

  class QuickForm extends HTMLElement {
    form = {}
    alertList = this.querySelector('div.alert-manager').querySelector('div.alert-list')
    alerts = this.querySelector('div.alert-manager').querySelectorAll('div.alert')
    findValues(inputs: NodeListOf<any>) {
      Array.from(inputs).forEach((input) => {
        if (input.name) {
          this.form[input.name] = (input.type === "checkbox") ? input.checked : input.value;
        }
      })
    }

    constructor() {
      super()
      const buttons = this.querySelectorAll('button')
      const inputs = this.querySelectorAll('input')
      const textareas = this.querySelectorAll('textarea')
      const selectors = this.querySelectorAll('select')

      const proposals = JSON.parse(this.dataset.proposals)
      const button = Array.from(buttons).find(btn => btn.id === 'submit')
      
      button.addEventListener('click', async() => {
        this.form = {}
        this.findValues(inputs)
        this.findValues(textareas)
        this.findValues(selectors)
        const lang = document.documentElement.lang
        if (this.form['topicQuestion'] === '') {
          addAlert(this.alertList, this.alerts[0].cloneNode(true))
        }
        else {
          addAlert(this.alertList, this.alerts[1].cloneNode(true))
          this.form['strategy'] = this.dataset.strategy
          this.form['proposals'] = this.form['defaultProposals'] ? proposals : [] 
          let res: any, json: any;
          if (import.meta.env.DEV) {
            window.location.href = `/${lang !== 'en' ? lang + '/' : '' }quick/dev/proposals`
          }
          else {
            try {
              res = await fetch(`${location.origin}/api/quick/process`, {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(this.form)
              });
              json = await res.json();
            } catch (error) {
              console.error(error);
              return;
            }
            window.location.href = `/${lang !== 'en' ? lang + '/' : '' }quick/${json.id}/proposals`
          }
        }
      })
    }
  }
  customElements.define('quick-form', QuickForm)

</script>